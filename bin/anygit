#!/usr/bin/env python
import logging
import optparse
import os
import sys

from anygit.data import crawl, physical_git, cleanup

logger = logging.getLogger('anygit.bin.anygit')

def main():
    parser = optparse.OptionParser(usage='%prog [opts] (index|dedup)')
    parser.add_option("-a", "--no-add", action="store_false",
                      default=True, dest="add")
    parser.add_option("-f", "--no-fetch", action="store_false",
                      default=True, dest="fetch")
    parser.add_option("-i", "--no-index", action="store_false",
                      default=True, dest="index")

    (opts, args) = parser.parse_args()
    if not len(args):
        parser.print_help()
        return 1
    action = args[0]
    if action == 'index':
        url = args[1]
        logger.debug('Starting to index: %s' % url)
        if opts.add:
            crawl.add_repo(url)
        if opts.fetch:
            crawl.fetch_repo(url)
        if opts.index:
            crawl.index_repo(url)
    elif action == 'dedup':
        logger.debug('Deduping')
        cleanup.dedup()
    elif action == 'delete_all':
        logger.debug('Deleting all')
        if raw_input('Are you sure? [yN] ').lower().startswith('y'):
            cleanup.delete_all()
    return 0

if __name__ == '__main__':
    sys.exit(main())
